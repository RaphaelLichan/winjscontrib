/* 
 * WinJS Contrib v2.0.2.0
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(){"use strict";function n(n){return encodeURIComponent(n)+".json"}function t(t,e,r){return t.getItemAsync(n(e)).then(function(n){return n},function(){}).then(function(n){return n?n.deleteAsync().then(function(){r&&r.debug("item deleted "+n.path)},function(){r&&r.error("cannot delete item "+n.path)}):WinJS.Promise.wrap([])})}function e(n,t){return Windows.Storage.FileIO.readBufferAsync(n).then(function(n){if(!t)return n;if(n.length){var e=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider;return e.unprotectAsync(n)}return null}).then(function(n){var t=null;if(n){var e=Windows.Security.Cryptography.CryptographicBuffer.convertBinaryToString(Windows.Security.Cryptography.BinaryStringEncoding.utf8,n);if(e)try{t=JSON.parse(e)}catch(r){}}return t})}function r(t,i,o,a,s,u){return new WinJS.Promise(function(c,f){s=s||0,a=a||Windows.Storage.CreationCollisionOption.openIfExists;var d=n(i);t.getFileAsync(d).then(function(n){return e(n,o)}).then(function(e){u&&u.debug("read "+t.path+"\\"+n(i)),c(e)},function(e){return-2147024894==e.number?(u&&u.debug("read empty "+t.path+"\\"+n(i)),void c()):(u&&u.warn("error reading "+t.path+"\\"+n(i)),void(2>s?setImmediate(function(){u&&u.debug("retry reading "+t.path+"\\"+n(i)),r(t,i,o,a,s+1,u).then(c,f)}):f({message:"fatal error reading "+t.path+"\\"+n(i),exception:e})))})})}function i(t,e,r,o,a,s,u){return new WinJS.Promise(function(c,f){function d(d){u&&u.warn("error writing "+t.path+"\\"+n(e)),2>s?setImmediate(function(){u&&u.debug("retry writing "+t.path+"\\"+n(e)),i(t,e,r,o,a,s+1,u).then(c,f)}):f({message:"fatal error writing "+t.path+"\\"+n(e)+"\r\n",exception:d})}s=s||0,a=a||Windows.Storage.CreationCollisionOption.replaceExisting;var p=Windows.Security.Cryptography.CryptographicBuffer.convertStringToBinary(JSON.stringify(r),Windows.Security.Cryptography.BinaryStringEncoding.utf8),l=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider("Local=user"),g=t.createFileAsync(n(e),a),h=o?l.protectAsync(p):WinJS.Promise.wrap(p);WinJS.Promise.join([g,h]).then(function(n){var t=n[0],e=n[1];Windows.Storage.FileIO.writeBufferAsync(t,e).then(function(){u&&u.debug("file written "+t.path),c(t)},d)},d)})}WinJS.Namespace.define("WinJSContrib.DataContainer",{WinRTFilesContainer:WinJS.Class.define(function(n,t,e){var r=this;if(r.key=n,r.options=t||{},r.parent=e,r.folderPromise,!window.Windows)throw"WinRT is required !";n?e&&(r.folderPromise=e.folderPromise.then(function(t){return r.options.logger&&r.options.logger.debug("open folder "+n),t.createFolderAsync(n,Windows.Storage.CreationCollisionOption.openIfExists)}).then(function(n){return r.folder=n,n})):(r.folder=Windows.Storage.ApplicationData.current.localFolder,r.folderPromise=WinJS.Promise.wrap(r.folder))},{read:function(n){var t=this;return t.folderPromise.then(function(e){return r(e,n,t.options.encrypted,Windows.Storage.CreationCollisionOption.openIfExists,0,t.options.logger)})},save:function(n,t){var e=this;return e.folderPromise.then(function(r){return i(r,n,t,e.options.encrypted,Windows.Storage.CreationCollisionOption.replaceExisting,0,e.options.logger)})},remove:function(n){var e=this;return e.folderPromise.then(function(r){return t(r,n,e.options.logger)})},list:function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync()})},child:function(n){if(this[n])return this[n];var t=new WinJSContrib.DataContainer.WinRTFilesContainer(n,this.options,this);return this[n]=t,t}})})}();