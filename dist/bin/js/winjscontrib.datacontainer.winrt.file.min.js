/* 
 * WinJS Contrib v2.0.2.0
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(n){"use strict";function t(n){return encodeURIComponent(n)+".json"}function e(n,e,r){return n.getItemAsync(t(e)).then(function(n){return n},function(){}).then(function(n){return n?n.deleteAsync().then(function(){r&&r.debug("item deleted "+n.path)},function(){r&&r.error("cannot delete item "+n.path)}):WinJS.Promise.wrap([])})}function r(n,t){return Windows.Storage.FileIO.readBufferAsync(n).then(function(n){if(!t)return n;if(n.length){var e=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider;return e.unprotectAsync(n)}return null}).then(function(n){var t=null;if(n){var e=Windows.Security.Cryptography.CryptographicBuffer.convertBinaryToString(Windows.Security.Cryptography.BinaryStringEncoding.utf8,n);if(e)try{t=JSON.parse(e)}catch(r){}}return t})}function i(n,e,o,a,s,u){return new WinJS.Promise(function(c,f){s=s||0,a=a||Windows.Storage.CreationCollisionOption.openIfExists;var p=t(e);n.getFileAsync(p).then(function(n){return r(n,o)}).then(function(r){u&&u.debug("read "+n.path+"\\"+t(e)),c(r)},function(r){return-2147024894==r.number?(u&&u.debug("read empty "+n.path+"\\"+t(e)),void c()):(u&&u.warn("error reading "+n.path+"\\"+t(e)),void(2>s?setImmediate(function(){u&&u.debug("retry reading "+n.path+"\\"+t(e)),i(n,e,o,a,s+1,u).then(c,f)}):f({message:"fatal error reading "+n.path+"\\"+t(e),exception:r})))})})}function o(n,e,r,i,a,s,u){return new WinJS.Promise(function(c,f){function p(p){u&&u.warn("error writing "+n.path+"\\"+t(e)),2>s?setImmediate(function(){u&&u.debug("retry writing "+n.path+"\\"+t(e)),o(n,e,r,i,a,s+1,u).then(c,f)}):f({message:"fatal error writing "+n.path+"\\"+t(e)+"\r\n",exception:p})}s=s||0,a=a||Windows.Storage.CreationCollisionOption.replaceExisting;var d=Windows.Security.Cryptography.CryptographicBuffer.convertStringToBinary(JSON.stringify(r),Windows.Security.Cryptography.BinaryStringEncoding.utf8),l=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider("Local=user"),g=n.createFileAsync(t(e),a),h=i?l.protectAsync(d):WinJS.Promise.wrap(d);WinJS.Promise.join([g,h]).then(function(n){var t=n[0],e=n[1];Windows.Storage.FileIO.writeBufferAsync(t,e).then(function(){u&&u.debug("file written "+t.path),c(t)},p)},p)})}WinJS.Namespace.define("WinJSContrib.DataContainer",{WinRTFilesContainer:WinJS.Class.define(function(t,e,r){var i=this;if(i.key=t,i.options=e||{},i.parent=r,i.folderPromise,!n.Windows)throw"WinRT is required !";t?r&&(i.folderPromise=r.folderPromise.then(function(n){return i.options.logger&&i.options.logger.debug("open folder "+t),n.createFolderAsync(t,Windows.Storage.CreationCollisionOption.openIfExists)}).then(function(n){return i.folder=n,n})):(i.folder=Windows.Storage.ApplicationData.current.localFolder,i.folderPromise=WinJS.Promise.wrap(i.folder))},{read:function(n){var t=this;return t.folderPromise.then(function(e){return i(e,n,t.options.encrypted,Windows.Storage.CreationCollisionOption.openIfExists,0,t.options.logger)})},save:function(n,t){var e=this;return e.folderPromise.then(function(r){return o(r,n,t,e.options.encrypted,Windows.Storage.CreationCollisionOption.replaceExisting,0,e.options.logger)})},remove:function(n){var t=this;return t.folderPromise.then(function(r){return e(r,n,t.options.logger)})},list:function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync()})},child:function(n){if(this[n])return this[n];var t=new WinJSContrib.DataContainer.WinRTFilesContainer(n,this.options,this);return this[n]=t,t}})})}(this);