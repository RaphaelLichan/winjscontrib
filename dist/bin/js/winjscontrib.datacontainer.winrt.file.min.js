/* 
 * WinJS Contrib v2.1.0.2
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(n){"use strict";function t(n){return encodeURIComponent(n)+".json"}function e(n,e,r){return n.getItemAsync(t(e)).then(function(n){return n},function(){}).then(function(n){return n?n.deleteAsync().then(function(){r&&r.debug("item deleted "+n.path)},function(t){r&&r.error("cannot delete item "+n.path)}):WinJS.Promise.wrap([])})}function r(n,t){return Windows.Storage.FileIO.readBufferAsync(n).then(function(n){if(!t)return n;if(n.length){var e=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider;return e.unprotectAsync(n)}return null}).then(function(n){var t=null;if(n){var e=Windows.Security.Cryptography.CryptographicBuffer.convertBinaryToString(Windows.Security.Cryptography.BinaryStringEncoding.utf8,n);if(e)try{t=JSON.parse(e)}catch(r){}}return t})}function i(n,e,o,a,c,s){return new WinJS.Promise(function(u,h){c=c||0,a=a||Windows.Storage.CreationCollisionOption.openIfExists;var f=t(e);n.getFileAsync(f).then(function(n){return r(n,o)}).then(function(r){s&&s.debug("read "+n.path+"\\"+t(e)),u(r)},function(r){return-2147024894==r.number?(s&&s.debug("read empty "+n.path+"\\"+t(e)),void u()):(s&&s.warn("error reading "+n.path+"\\"+t(e)),void(2>c?setImmediate(function(){s&&s.debug("retry reading "+n.path+"\\"+t(e)),i(n,e,o,a,c+1,s).then(u,h)}):h({message:"fatal error reading "+n.path+"\\"+t(e),exception:r})))})})}function o(n,e,r,i,a,c,s){return new WinJS.Promise(function(u,h){function f(f){s&&s.warn("error writing "+n.path+"\\"+t(e)),2>c?setImmediate(function(){s&&s.debug("retry writing "+n.path+"\\"+t(e)),o(n,e,r,i,a,c+1,s).then(u,h)}):h({message:"fatal error writing "+n.path+"\\"+t(e)+"\r\n",exception:f})}c=c||0,a=a||Windows.Storage.CreationCollisionOption.replaceExisting;var l=Windows.Security.Cryptography.CryptographicBuffer.convertStringToBinary(JSON.stringify(r),Windows.Security.Cryptography.BinaryStringEncoding.utf8);if(i)var d=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider("Local=user");var p=n.createFileAsync(t(e),a),g=i?d.protectAsync(l):WinJS.Promise.wrap(l);WinJS.Promise.join([p,g]).then(function(n){var t=n[0],e=n[1];Windows.Storage.FileIO.writeBufferAsync(t,e).then(function(){s&&s.debug("file written "+t.path),u(t)},f)},f)})}WinJS.Namespace.define("WinJSContrib.DataContainer",{WinRTFilesContainer:WinJS.Class.define(function(t,e,r){var i=this;if(i.key=t,i.options=e||{},i.parent=r,i.folderPromise,i.useDataCache=i.options.useDataCache||!1,i.dataCache={},i.childs={},!n.Windows)throw"WinRT is required !";t?r&&(i.folderPromise=r.folderPromise.then(function(n){return i.options.logger&&i.options.logger.debug("open folder "+t),n.createFolderAsync(t,Windows.Storage.CreationCollisionOption.openIfExists)}).then(function(n){return i.folder=n,n})):(i.folder=Windows.Storage.ApplicationData.current.localFolder,i.folderPromise=WinJS.Promise.wrap(i.folder))},{read:function(n){var t=this;if(t.useDataCache){var e=t.dataCache[n];if(e){var r=JSON.parse(JSON.stringify(e));return WinJS.Promise.wrap(r)}}return t.folderPromise.then(function(e){return i(e,n,t.options.encrypted,Windows.Storage.CreationCollisionOption.openIfExists,0,t.options.logger).then(function(e){return t.useDataCache&&(t.dataCache[n]=e),e})})},save:function(n,t){var e=this;return e.useDataCache&&(e.dataCache[n]=t),e.folderPromise.then(function(r){return o(r,n,t,e.options.encrypted,Windows.Storage.CreationCollisionOption.replaceExisting,0,e.options.logger)})},remove:function(n){var t=this;return t.folderPromise.then(function(r){return e(r,n,t.options.logger)})},listKeys:function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync().then(function(t){return t.map(function(t){var e=t.path.substr(n.path.length+1),r=e.indexOf(".json");return r>0&&(e=e.substr(0,r)),e})})})},list:function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync()})},child:function(n){if(this.childs[n])return this.childs[n];var t=new WinJSContrib.DataContainer.WinRTFilesContainer(n,this.options,this);return this.childs[n]=t,t},childWithTransaction:function(n,t){var e=this;return this.child(n+"-tmp").folderPromise.then(function(t){return t.deleteAsync().then(function(){return e.child(n+"-tmp")})}).then(function(r){return t(r).then(function(t){return r.folderPromise.then(function(t){return t.renameAsync(n,Windows.Storage.NameCollisionOption.replaceExisting).then(function(){return e.childs[n]=null,e.childs[n+"-tmp"]=null,e.child(n)})})})})},deleteContainer:function(){var n=this;return n.folderPromise.then(function(n){return n.deleteAsync()})},clearAllCache:function(){var n=this;n.clearCache(),n.clearDataCache()},clearCache:function(){var n=this;n.childs={};for(var t in n.childs)n.childs.hasOwnProperty(t)&&n.childs[t].clearCache()},clearDataCache:function(){var n=this;n.dataCache={};for(var t in n.childs)n.childs.hasOwnProperty(t)&&n.childs[t].clearDataCache()}})})}(this);