/* 
 * WinJS Contrib v2.1.0.4
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var WinJSContrib=WinJSContrib||{};WinJSContrib.BgDownloads=WinJSContrib.BgDownloads||{},function(){"use strict";var n=Windows.Storage.ApplicationData.current.localFolder,e="downloadeditems.json",t=WinJS.Binding.define({download:null,status:null,progress:0}),o=WinJSContrib.Logs.getLogger("WinJSContrib.BgDownloadTracker"),r={waiting:"waiting",downloading:"downloading",downloaded:"downloaded",error:"error",completed:"completed"};WinJSContrib.BgDownloads.Tracker=WinJS.Class.mix(WinJS.Class.define(function(n,e){var t=this;t.name=n,e=e||{},this.saveItemsPromise=WinJS.Promise.wrap(),this.downloadsStart=WinJS.Promise.wrap(),this.folder=e.folder,this.retryOnError=e.retryOnError,this.handleItemProperties=e.handleItemProperties,this.maxConcurrentDownloads=e.maxConcurrentDownloads||300,this.debouncedCheck=_.debounce(function(){t.checkDownloads()},200,!1),this.debouncedSave=_.debounce(function(){t.saveItems()},200,!1),e.getFolder&&(this.getFolder=e.getFolder),e.createFolder&&(this.createFolder=e.createFolder),this.items=new WinJS.Binding.List,this.defaultFolderPromise=t._getFolder(!0),t.ready=!1},{_getFolder:function(n){return this.folder?WinJS.Promise.wrap(this.folder):n?this.createFolder():this.getFolder()},getFolder:function(){return n.getFolderAsync("bgdownloads\\"+this.name,Windows.Storage.CreationCollisionOption.openIfExists)},createFolder:function(e){return n.createFolderAsync("bgdownloads\\"+this.name,Windows.Storage.CreationCollisionOption.openIfExists)},_loadItemsFile:function(){var n=this;return n._getFolder(!1).then(function(n){return n?n.getFileAsync(e).then(function(n){return Windows.Storage.FileIO.readTextAsync(n).then(function(n){var e=n?JSON.parse(n):{};return e})}):void 0},function(n){return o.error("internal error loading items",n),[]})},verifyItems:function(){var n=this,e=[];return n.items.forEach(function(t){e.push(t.status==r.downloading&&t.downloadid&&!t.download?n._swapTempFile(t).then(function(){return n._checkItem(t)}):n._checkItem(t))}),WinJS.Promise.join(e).then(function(){return n.saveItems()}).then(function(){return n.checkDownloads()})},loadItems:function(){var n=this,e=function(e){return n.items.splice(0,n.items.length),n._loadItemsFile().then(function(t){if(t&&t.items&&t.items.length){var o=[];return t.items.forEach(function(t){if(t){var i=n._wrap(t,e);n.items.push(i),o.push(i.status==r.downloading&&i.downloadid&&!i.download?n._swapTempFile(i).then(function(){return n._checkItem(i)}):n._checkItem(i))}}),WinJS.Promise.join(o).then(function(){n.saveItems(),n.ready=!0})}n.ready=!0,n.saveItems()},function(e){o.error("error loading items",e),n.ready=!0})};return WinJSContrib.BgDownloads.initDownloads().then(function(n){return e(n)},function(n){return e([])}).then(function(){return n.checkDownloads()},function(n){return o.error("tracker error",n),WinJS.Promise.wrap()})},saveItems:function(n){var t=this;return t.saveItemsPromise.then(function(){var r=t.items.map(t._unwrap);return t.saveItemsPromise=t.defaultFolderPromise.then(function(n){return n.createFileAsync(e,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(n){return Windows.Storage.FileIO.writeTextAsync(n,JSON.stringify({items:r}))})}).then(null,function(e){return o.warn("error saving bgdownload tracker items",e),n=n||0,2>n?WinJS.Promise.timeout(20).then(function(){return t.saveItemsPromise=t.saveItems(n+1),t.saveItemsPromise}):void o.error("error saving bgdownload tracker items",e)}),t.saveItemsPromise})},attach:function(n,e){var t=this;e.oncomplete=function(){n.download=null,t._swapTempFile(n).then(function(){return t._checkItem(n)}).then(function(){t.debouncedSave(),o.debug("bgdownload complete",{data:n.data}),t.debouncedCheck(),t.dispatchEvent("downloadcomplete",{data:n.data})},function(n){return o.error("error swapping temp file",n),WinJS.Promise.wrap()})},e.onerror=function(e){n.status=r.error,n.download=null,n.downloadid=null;var i=WinJS.Promise.wrap();e.asyncOpType&&"Windows.Foundation.IAsyncOperationWithProgress`2<Windows.Networking.BackgroundTransfer.DownloadOperation,Windows.Networking.BackgroundTransfer.DownloadOperation>"==e.asyncOpType&&e.message&&e.message.indexOf("(404)")>0&&(n.status=r.downloaded,o.warn("remote item not found, skipping item "+n.itemid),i=t._checkItem(n)),i.then(function(){return t.removeFile(n)}).then(function(){n.filepath=null}).then(function(){t.debouncedSave(),t.debouncedCheck()},function(n){return o.error("error removing file on error",n),WinJS.Promise.wrap()}),e.item=n.data,o.debug("bgdownload error",{error:e,data:n.data}),t.dispatchEvent("downloaderror",e)},e.onprogress=function(e){n.progress=e}},_wrap:function(n,e){var o=this,r=new t;if(r.data=n.data,r.itemid=n.itemid,r.folderpath=n.folderpath,r.uri=n.uri,r.filename=n.filename,r.filepath=n.filepath,r.status=n.status,r.downloadid=n.downloadid,r.downloadid&&e&&e.length){var e=e.filter(function(n){return n.download.guid==r.downloadid});e&&e.length&&(r.download=e[0],o.attach(r,e[0]))}return r},_checkItem:function(n){var e=this,t=function(){if(n.status!=r.completed){n.status=r.downloaded;var t=e.items.indexOf(n);if(t>=0&&e.items.splice(t,1),e.handleItemProperties)return WinJS.Promise.as(e.handleItemProperties(n.data,file)).then(function(){n.status=r.completed},function(n){return o.error("error handling tracker items properties",n),WinJS.Promise.wrap()});n.status=r.completed}};return n.status===r.downloading||n.status===r.waiting?WinJS.Promise.wrap():n.status===r.error?WinJS.Promise.wrap():Windows.Storage.StorageFile.getFileFromPathAsync(n.filepath).then(function(n){n&&t()},function(e){return n.status=r.error,WinJS.Promise.wrap()})},_swapTempFile:function(n){var e=".download";return n.filepath.indexOf(e)>0?Windows.Storage.StorageFile.getFileFromPathAsync(n.filepath).then(function(e){return e?e.renameAsync(n.filename,Windows.Storage.NameCollisionOption.replaceExisting).then(function(t){n.status=r.downloaded,n.filepath=e.path}):void 0},function(e){return o.error("internal error swapping temp file",e),n.status=r.error,WinJS.Promise.wrap()}):(o.error("invalid temp file"),n.status=r.error,WinJS.Promise.wrap())},_unwrap:function(n){var e={itemid:n.itemid,data:n.data,uri:n.uri,folderpath:n.folderpath,filename:n.filename,filepath:n.filepath,downloadid:n.downloadid,status:n.status};return e},add:function(n,e,o,i,a){var s=this,d=s.items.filter(function(n){return n.itemid==e});if(!d||!d.length){var l=new t;l.itemid=e,l.data=n,l.folderpath=o,l.filename=i,l.uri=a,l.status=r.waiting,s.items.push(l),s.debouncedCheck(),s.debouncedSave()}},startDownloads:function(n){var e=this;return n.forEach(function(n){n.status=r.downloading}),e.downloadsStart.then(function(){var t=[];return n.forEach(function(n){var i=null;if(n){i=n.folderpath?Windows.Storage.StorageFolder.getFolderFromPathAsync(n.folderpath):e.defaultFolderPromise;var a=i.then(function(t){if(WinJSContrib.BgDownloads.currentDownloads.length>e.maxConcurrentDownloads)return n.status=r.waiting,o.debug("too much pendings dl "+WinJSContrib.BgDownloads.currentDownloads.length+"/"+e.maxConcurrentDownloads+" "+e.items.length),WinJS.Promise.wrap();var i=new WinJSContrib.BgDownloads.Download,a=encodeURIComponent(n.filename),s=new Windows.Foundation.Uri(n.uri);return i.start(s,a+".download",t,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(t){o.debug("bgdownload start "+WinJSContrib.BgDownloads.currentDownloads.length+"/"+e.maxConcurrentDownloads+" "+e.items.length),n.status=r.downloading,n.download=t,n.downloadid=t.download.guid,n.filepath=t.file,e.attach(n,t)}).then(null,function(e){o.error("download start error "+e),n.status=r.error,n.download=null,n.downloadid=null})});t.push(a)}}),e.downloadsStart=WinJS.Promise.join(t).then(function(){return e.saveItems()},function(n){return o.error("error starting dowloads",n),WinJS.Promise.wrap()}),e.downloadsStart})},checkDownloads:function(){var n=this;return WinJSContrib.BgDownloads.currentDownloads.length>n.maxConcurrentDownloads?(o.debug("too much pendings "+WinJSContrib.BgDownloads.currentDownloads.length+"/"+n.maxConcurrentDownloads+" "+n.items.length),WinJS.Promise.wrap()):(n.items.length&&0==WinJSContrib.BgDownloads.currentDownloads.length&&n.verifyItems(),o.debug("checking downloads"),n.downloadsStart.then(function(){var e=n.items.filter(function(n){return n.status==r.waiting||n.status==r.error});if(o.debug(e.length+" files to download"+WinJSContrib.BgDownloads.currentDownloads.length+"/"+n.maxConcurrentDownloads+" "+n.items.length),e.length){var t=WinJSContrib.BgDownloads.currentDownloads.length;if(WinJSContrib.BgDownloads.currentDownloads.length<n.maxConcurrentDownloads){var i=e.slice(0,n.maxConcurrentDownloads-t);return n.startDownloads(i)}}return WinJS.Promise.wrap()}))},removeFile:function(n){var e=this;console.log("remove item file for "+n.itemid);var t=e.items.indexOf(n);return t>=0?(console.log("remove item file for "+n.itemid+" "+n.filepath),Windows.Storage.StorageFile.getFileFromPathAsync(n.filepath).then(function(n){return n?n.deleteAsync():void 0},function(e){return console.error("file not found "+n.filepath,e),WinJS.Promise.wrap()})):WinJS.Promise.wrap()},remove:function(n){var e=this;console.log("remove item "+n.itemid);var t=e.items.indexOf(n);return t>=0?Windows.Storage.StorageFile.getFileFromPathAsync(n.filepath).then(function(n){return n.deleteAsync()},function(n){return console.error("file not found",n),WinJS.Promise.wrap()}).then(function(){return e.items.splice(t,1),e.saveItems()}):WinJS.Promise.wrap()},exists:function(n){var e=this,t=e.items.filter(function(e){return e.itemid==n});return t.length>0},get:function(n){var e=this,t=e.items.filter(function(e){return e.itemid==n});return t&&t.length?t[0]:null}}),WinJS.Utilities.eventMixin,WinJS.Utilities.createEventProperties(["downloadcomplete","downloaderror"]))}();